<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guitar Trainer Pro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Application d'entra√Ænement pour guitare avec d√©tection audio en temps r√©el">
    <meta name="theme-color" content="#00d4aa">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Guitar Trainer">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #151a23;
            --bg-tertiary: #1f2937;
            --accent-primary: #00d4aa;
            --accent-secondary: #00a8ff;
            --accent-danger: #ff3366;
            --accent-warning: #ffaa00;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border: #30363d;
            --success: #3fb950;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1117 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
        }

        h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.5rem;
            margin-bottom: 1rem;
            transition: grid-template-columns 0.3s ease;
        }
        
        .main-grid.settings-hidden {
            grid-template-columns: 1fr;
            justify-items: center;
        }
        
        .main-grid.settings-hidden .display-panel {
            max-width: 1200px;
            width: 100%;
        }

        .settings-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid var(--border);
            height: fit-content;
            position: sticky;
            top: 1rem;
            transition: all 0.3s ease;
        }
        
        .settings-panel.hidden {
            display: none;
        }

        .section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .mode-selector {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-bottom: 1.25rem;
        }

        .difficulty-selector {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-bottom: 1.25rem;
        }

        .mode-btn, .difficulty-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: left;
        }

        .mode-btn:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .mode-btn.active, .difficulty-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: transparent;
            color: var(--bg-primary);
        }

        .setting-group {
            margin-bottom: 1rem;
        }

        .setting-label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.4rem;
            border-radius: 6px;
            transition: background 0.2s;
            font-size: 0.85rem;
        }

        .checkbox-label:hover {
            background: var(--bg-tertiary);
        }

        .chord-types-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.3rem;
        }

        .chord-only-section {
            display: block;
        }

        .chord-only-section.hidden {
            display: none;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .display-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid var(--border);
            height: fit-content;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .exercise-display {
            text-align: center;
        }

        .timer-display {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 2px solid var(--border);
            display: inline-block;
        }

        .timer-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.25rem;
        }

        .timer-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .timer-value.warning {
            color: var(--accent-warning);
            animation: timerPulse 0.5s infinite;
        }

        .timer-value.danger {
            color: var(--accent-danger);
            animation: timerPulse 0.3s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .current-note {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3rem;
            font-weight: 700;
            margin: 0.75rem 0;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .note-notation {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .notation {
            text-align: center;
        }

        .notation-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.25rem;
        }

        .notation-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .chord-notes-display {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border);
        }

        .chord-display-wrapper {
            display: flex;
            gap: 2rem;
            align-items: center;
            justify-content: center;
        }

        .chord-notes-section {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chord-notes-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        .chord-notes-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            color: var(--accent-primary);
            font-weight: 600;
            text-align: center;
            line-height: 1.4;
        }

        .chord-diagram-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .diagram-header {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chord-diagram-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-align: center;
        }

        .diagram-navigation {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .diagram-nav-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--accent-primary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .diagram-nav-btn:hover:not(:disabled) {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .diagram-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .position-indicator {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: center;
        }

        .chord-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .diagram-fret-info {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .diagram-grid {
            position: relative;
            display: inline-block;
        }

        .diagram-string {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .diagram-string-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            width: 30px;
            text-align: center;
            font-weight: 600;
        }

        .diagram-fret {
            width: 45px;
            height: 30px;
            border: 1px solid var(--border);
            border-left: none;
            border-top: none;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .diagram-fret:first-of-type {
            border-left: 3px solid var(--text-primary);
        }

        .diagram-string:first-child .diagram-fret {
            border-top: 1px solid var(--border);
        }

        .diagram-finger {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(0, 212, 170, 0.4);
        }

        .diagram-open {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid var(--success);
            background: transparent;
        }

        .diagram-muted {
            color: var(--accent-danger);
            font-size: 1.1rem;
            font-weight: 700;
        }

        .diagram-legend {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fret-numbers {
            display: flex;
            margin-top: 0.5rem;
            padding-left: 30px;
        }

        .fret-number {
            width: 45px;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .control-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.6rem 1.25rem;
            border: none;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 170, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
        }

        .audio-detector {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .audio-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .status-indicator.active {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .detected-note {
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-top: 0.35rem;
        }

        .detected-note.correct {
            color: var(--success);
            animation: correctFlash 0.6s ease-in-out;
            font-weight: 700;
        }

        .detected-note.incorrect {
            color: var(--accent-danger);
        }

        @keyframes correctFlash {
            0%, 100% { 
                transform: scale(1);
                text-shadow: none;
            }
            50% { 
                transform: scale(1.3);
                text-shadow: 0 0 30px var(--success), 0 0 60px var(--success);
            }
        }

        .frequency-display {
            text-align: center;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .settings-panel {
                position: static;
            }

            h1 {
                font-size: 1.75rem;
            }

            .current-note {
                font-size: 3rem;
            }

            .chord-display-wrapper {
                flex-direction: column;
                align-items: center;
            }

            .chord-notes-section {
                text-align: center;
                min-height: auto;
            }

            .chord-notes-label,
            .chord-notes-value {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toggle settings button -->
        <button id="toggleSettingsBtn" style="position: fixed; top: 1rem; left: 1rem; z-index: 1000; padding: 0.75rem 1rem; background: var(--bg-secondary); border: 2px solid var(--accent-primary); border-radius: 10px; color: var(--accent-primary); font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);"
        onmouseover="this.style.background='var(--accent-primary)'; this.style.color='var(--bg-primary)'"
        onmouseout="this.style.background='var(--bg-secondary)'; this.style.color='var(--accent-primary)'">
            ‚öôÔ∏è
        </button>
        
        <header>
            <h1>GUITAR TRAINER PRO</h1>
            <p class="subtitle">Entra√Ænement avanc√© avec d√©tection audio</p>
        </header>

        <div class="main-grid" id="mainGrid">
            <!-- Settings Panel -->
            <div class="settings-panel" id="settingsPanel">
                <!-- 1. Mode d'exercice -->
                <div class="section-title">Mode d'exercice</div>
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="single">
                        üìç Notes individuelles
                    </button>
                    <button class="mode-btn" data-mode="speed">
                        ‚ö° Mode rapidit√©
                    </button>
                    <button class="mode-btn" data-mode="chords">
                        üéº Accords
                    </button>
                </div>

                <!-- 2. Niveau de difficult√© -->
                <div class="section-title">Niveau de difficult√©</div>
                <div class="difficulty-selector">
                    <button class="difficulty-btn" data-difficulty="beginner">
                        üå± D√©butant (5 notes)
                    </button>
                    <button class="difficulty-btn active" data-difficulty="intermediate">
                        üìö Interm√©diaire (7 notes)
                    </button>
                    <button class="difficulty-btn" data-difficulty="advanced">
                        üé∏ Avanc√© (12 notes)
                    </button>
                    <!-- Expert mode temporarily disabled -->
                    <!--
                    <button class="difficulty-btn" data-difficulty="expert">
                        üèÜ Expert (multi-cordes)
                    </button>
                    -->
                </div>

                <!-- 3. Mode rapidit√© (conditionnel) -->
                <div id="speedModeSettings" style="display: none;">
                    <div class="section-title">Mode rapidit√©</div>
                    <div class="setting-group">
                        <label class="setting-label">Dur√©e du d√©fi (secondes)</label>
                        <input type="number" id="speedModeDuration" min="30" max="300" step="30" value="60">
                    </div>
                </div>

                <!-- 3b. Mode accords (conditionnel) -->
                <div id="chordsModeSettings" style="display: none;">
                    <div class="section-title">Mode accords</div>
                    <div class="setting-group">
                        <label class="setting-label">Types d'accords</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="chordTypeMajor" checked>
                                <span>Majeur</span>
                            </label>
                            <label class="checkbox-label" style="margin: 0;">
                                <input type="checkbox" id="chordTypeMinor" checked>
                                <span>Mineur</span>
                            </label>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Niveau</label>
                        <select id="chordsLevel" style="width: 100%; padding: 0.5rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: 'DM Sans', sans-serif; font-size: 0.9rem;">
                            <option value="basic" selected>üå± Basiques (5 accords)</option>
                            <option value="complete">üìö Complet (12 tonalit√©s)</option>
                        </select>
                    </div>
                </div>

                <!-- 4. Visualisation manche -->
                <div class="section-title">Visualisation manche</div>
                <div class="setting-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="showFretboardCheckbox">
                        <span>Afficher la position sur le manche</span>
                    </label>
                </div>
                <div class="setting-group" id="instrumentSelection" style="display: none;">
                    <label class="setting-label">Type d'instrument</label>
                    <select id="instrumentType" style="width: 100%; padding: 0.5rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: 'DM Sans', sans-serif; font-size: 0.9rem;">
                        <option value="guitar-6">Guitare 6 cordes</option>
                        <option value="guitar-7">Guitare 7 cordes</option>
                        <option value="bass-4">Basse 4 cordes</option>
                        <option value="bass-5">Basse 5 cordes</option>
                    </select>
                </div>
                <div class="setting-group" id="fretCountSelection" style="display: none;">
                    <label class="setting-label">Nombre de frettes</label>
                    <select id="fretCount" style="width: 100%; padding: 0.5rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: 'DM Sans', sans-serif; font-size: 0.9rem;">
                        <option value="12" selected>12 frettes</option>
                        <option value="15">15 frettes</option>
                        <option value="24">24 frettes</option>
                    </select>
                </div>

                <!-- 5. D√©tection audio -->
                <div class="section-title">D√©tection audio</div>
                <div class="setting-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enableAudio" checked>
                        <span>Activer le microphone</span>
                    </label>
                </div>
                <div class="setting-group">
                    <label class="setting-label">D√©lai avant passage (secondes)</label>
                    <input type="number" id="advanceDelay" min="0.5" max="5" step="0.5" value="1">
                </div>
                
                <!-- 6. Lecture audio -->
                <div class="section-title">Lecture audio</div>
                <div class="setting-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="playSoundCheckbox">
                        <span>Jouer le son de la note</span>
                    </label>
                </div>
                
                <!-- Version display -->
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); text-align: center;">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">
                        Guitar Trainer Pro <span id="appVersion">v1.0.0</span>
                    </div>
                </div>
            </div>

            <!-- Display Panel -->
            <div class="display-panel">
                <!-- Settings open overlay message -->
                <div id="settingsOverlay" style="display: block; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; background: var(--bg-secondary); padding: 2rem; border-radius: 16px; border: 2px solid var(--accent-primary); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);">
                    <div style="font-size: 1.2rem; color: var(--accent-primary); margin-bottom: 0.5rem;">‚öôÔ∏è Configuration en cours</div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">Fermez les options pour commencer l'entra√Ænement</div>
                </div>
                
                <div class="exercise-display">
                    <!-- Speed mode stats (hidden by default) -->
                    <div id="speedModeStats" style="display: none; margin-bottom: 1rem; text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Dur√©e du d√©fi : <span id="speedModeDurationDisplay" style="color: var(--accent-primary); font-weight: 600;">60</span> secondes
                            <span style="opacity: 0.6; margin-left: 0.5rem;">(‚ò∞ Options pour modifier)</span>
                        </div>
                        <div style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem;">Temps restant</div>
                                <div id="speedModeTimer" style="font-family: 'JetBrains Mono', monospace; font-size: 1.8rem; font-weight: 700; color: var(--accent-primary);">60</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.25rem;">Score</div>
                                <div id="speedModeScore" style="font-family: 'JetBrains Mono', monospace; font-size: 1.8rem; font-weight: 700; color: var(--success);">0</div>
                            </div>
                        </div>
                        <button id="speedModeStartBtn" class="btn btn-primary" style="margin: 0 auto 0.75rem auto; justify-content: center;">
                            ‚ñ∂ D√©marrer le d√©fi
                        </button>
                    </div>
                    
                    <div id="singleNoteDisplay">
                        <div class="current-note" id="currentNote">‚Äî</div>
                        
                        <div class="note-notation">
                            <div class="notation">
                                <div class="notation-label">Internationale</div>
                                <div class="notation-value" id="intlNotation">‚Äî</div>
                            </div>
                            <div class="notation">
                                <div class="notation-label">Fran√ßaise</div>
                                <div class="notation-value" id="frNotation">‚Äî</div>
                            </div>
                        </div>
                    </div>

                    <!-- Fretboard visualization -->
                    <div id="fretboardDisplay" style="display: none; margin-top: 1.5rem; width: 100%;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; text-align: center;">Position sur le manche</div>
                        <div id="fretboardCanvas" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 12px; border: 2px solid var(--border); overflow-x: auto; max-width: 100%;"></div>
                    </div>

                    <div class="chord-notes-display" id="chordNotesDisplay" style="display: none;">
                        <div class="chord-display-wrapper">
                            <div class="chord-notes-section">
                                <div class="chord-notes-label">Progression</div>
                                <div class="chord-notes-value" id="chordNotesValue">0/3 notes d√©tect√©es</div>
                            </div>
                        </div>
                    </div>

                    <div class="control-buttons" id="controlButtons">
                        <button class="btn btn-primary" id="nextBtn">
                            ‚ñ∂ Suivant
                        </button>
                    </div>

                    <div class="audio-detector" id="audioDetector" style="display: none;">
                        <div class="audio-status">
                            <div class="status-indicator" id="statusIndicator"></div>
                            <span id="statusText">Microphone d√©sactiv√©</span>
                        </div>
                        <div class="detected-note" id="detectedNote">‚Äî</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application version
        const APP_VERSION = 'v1.4.4';
        
        // CRITICAL: Check domain FIRST and unregister any existing service worker on invalid domains
        const hostname = window.location.hostname;
        const isValidDomain = !hostname.includes('claudeusercontent') && 
                              !hostname.includes('localhost') && 
                              hostname !== '127.0.0.1';
        
        // Unregister any existing service workers on invalid domains
        if (!isValidDomain && 'serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => {
                    registration.unregister();
                    console.log('Service worker d√©sinstall√© (domaine invalide)');
                });
            }).catch(err => {
                console.log('Cleanup service worker ignor√©');
            });
            
            // Also clear caches
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
        }
        
        // Note mappings
        const noteToFrench = {
            'C': 'Do', 'C#': 'Do#', 'Db': 'R√©b', 'D': 'R√©', 'D#': 'R√©#', 
            'Eb': 'Mib', 'E': 'Mi', 'F': 'Fa', 'F#': 'Fa#', 'Gb': 'Solb',
            'G': 'Sol', 'G#': 'Sol#', 'Ab': 'Lab', 'A': 'La', 'A#': 'La#',
            'Bb': 'Sib', 'B': 'Si'
        };

        const allNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // Chord types with their intervals (in semitones from root)
        const chordTypes = {
            'Majeur': { suffix: '', intervals: [0, 4, 7], french: 'Majeur' },
            'Mineur': { suffix: 'm', intervals: [0, 3, 7], french: 'Mineur' },
            '7': { suffix: '7', intervals: [0, 4, 7, 10], french: 'Septi√®me' },
            'Maj7': { suffix: 'Maj7', intervals: [0, 4, 7, 11], french: 'Septi√®me Majeure' },
            'm7': { suffix: 'm7', intervals: [0, 3, 7, 10], french: 'Mineur Septi√®me' },
            'dim': { suffix: 'dim', intervals: [0, 3, 6], french: 'Diminu√©' },
            'aug': { suffix: 'aug', intervals: [0, 4, 8], french: 'Augment√©' },
            'sus4': { suffix: 'sus4', intervals: [0, 5, 7], french: 'Suspendu 4' },
            'sus2': { suffix: 'sus2', intervals: [0, 2, 7], french: 'Suspendu 2' }
        };

        // Chord diagrams database (basic chords for training mode)
        // Format: frets = [-1 (X), 0 (open), 1-24 (fret number)]
        //         fingers = [0 (X/open), 1-4 (finger number)]
        const chordDiagrams = {
            // MAJOR CHORDS
            'C': { 
                name: 'Do Majeur', 
                notes: ['C', 'E', 'G'],
                frets: [-1, 3, 2, 0, 1, 0], // X-3-2-0-1-0
                fingers: [0, 3, 2, 0, 1, 0] // Index on B, Middle on D, Ring on A
            },
            'D': {
                name: 'R√© Majeur',
                notes: ['D', 'F#', 'A'],
                frets: [-1, -1, 0, 2, 3, 2],
                fingers: [0, 0, 0, 1, 3, 2]
            },
            'E': {
                name: 'Mi Majeur',
                notes: ['E', 'G#', 'B'],
                frets: [0, 2, 2, 1, 0, 0],
                fingers: [0, 2, 3, 1, 0, 0]
            },
            'F': {
                name: 'Fa Majeur',
                notes: ['F', 'A', 'C'],
                frets: [1, 3, 3, 2, 1, 1],
                fingers: [1, 3, 4, 2, 1, 1] // Barr√© index
            },
            'G': {
                name: 'Sol Majeur',
                notes: ['G', 'B', 'D'],
                frets: [3, 2, 0, 0, 0, 3],
                fingers: [2, 1, 0, 0, 0, 3]
            },
            'A': {
                name: 'La Majeur',
                notes: ['A', 'C#', 'E'],
                frets: [-1, 0, 2, 2, 2, 0],
                fingers: [0, 0, 1, 2, 3, 0]
            },
            'B': {
                name: 'Si Majeur',
                notes: ['B', 'D#', 'F#'],
                frets: [-1, 2, 4, 4, 4, 2],
                fingers: [0, 1, 2, 3, 4, 1] // Barr√©
            },
            
            // MINOR CHORDS
            'Am': {
                name: 'La Mineur',
                notes: ['A', 'C', 'E'],
                frets: [-1, 0, 2, 2, 1, 0],
                fingers: [0, 0, 2, 3, 1, 0]
            },
            'Dm': {
                name: 'R√© Mineur',
                notes: ['D', 'F', 'A'],
                frets: [-1, -1, 0, 2, 3, 1],
                fingers: [0, 0, 0, 2, 3, 1]
            },
            'Em': {
                name: 'Mi Mineur',
                notes: ['E', 'G', 'B'],
                frets: [0, 2, 2, 0, 0, 0],
                fingers: [0, 1, 2, 0, 0, 0]
            },
            'Fm': {
                name: 'Fa Mineur',
                notes: ['F', 'G#', 'C'],
                frets: [1, 3, 3, 1, 1, 1],
                fingers: [1, 3, 4, 1, 1, 1] // Barr√©
            },
            'Gm': {
                name: 'Sol Mineur',
                notes: ['G', 'A#', 'D'],
                frets: [3, 5, 5, 3, 3, 3],
                fingers: [1, 3, 4, 1, 1, 1] // Barr√©
            },
            'Bm': {
                name: 'Si Mineur',
                notes: ['B', 'D', 'F#'],
                frets: [-1, 2, 4, 4, 3, 2],
                fingers: [0, 1, 3, 4, 2, 1] // Barr√©
            },
            'Cm': {
                name: 'Do Mineur',
                notes: ['C', 'D#', 'G'],
                frets: [-1, 3, 5, 5, 4, 3],
                fingers: [0, 1, 3, 4, 2, 1] // Barr√©
            }
        };

        // Basic chords list (for beginner level)
        const basicChords = ['C', 'D', 'E', 'G', 'A', 'Am', 'Dm', 'Em'];

        // All chords for complete level
        const allChordsList = Object.keys(chordDiagrams);

        // State
        let currentMode = 'single';
        let currentDifficulty = 'intermediate';
        let currentExercise = null;
        
        // Note definitions for each difficulty level
        const difficultyLevels = {
            beginner: {
                name: 'D√©butant',
                notes: ['E', 'B', 'G', 'D', 'A'], // Open strings - unique notes only
                description: 'Cordes √† vide'
            },
            intermediate: {
                name: 'Interm√©diaire', 
                notes: ['C', 'D', 'E', 'F', 'G', 'A', 'B'], // Natural notes
                description: 'Notes naturelles'
            },
            advanced: {
                name: 'Avanc√©',
                notes: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'], // All chromatic
                description: 'Toutes les notes'
            },
            expert: {
                name: 'Expert',
                // Multi-string: same note on different strings
                notes: [
                    {note: 'E', strings: ['E2', 'E4']},
                    {note: 'F', strings: ['E2-1', 'E4-1']},
                    {note: 'G', strings: ['E2-3', 'D3', 'G3', 'E4-3']},
                    {note: 'A', strings: ['E2-5', 'A2', 'D3-7', 'G3-2', 'E4-5']},
                    {note: 'B', strings: ['A2-2', 'G3-4', 'B3', 'E4-7']},
                    {note: 'C', strings: ['A2-3', 'B3-1']},
                    {note: 'D', strings: ['A2-5', 'D3', 'B3-3', 'G3-7']},
                ],
                description: 'Multi-cordes'
            }
        };
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let isListening = false;
        let microphoneStream = null; // Store the stream to reuse it
        let microphonePermissionGranted = false; // Track if permission was already obtained
        let usedNotes = [];
        let availableNotes = [];
        let usedChords = [];
        let availableChords = [];
        let currentChordPositionIndex = 0;
        let currentChordName = null;
        let lastDetectedNote = null;
        let noteDetectionStartTime = 0;
        let stableNoteDuration = 100; // 100 milliseconds (responsive but stable)
        let hasAutoAdvanced = false;
        let waitingForRelease = false;
        let wakeLock = null;
        let audioContextSynth = null;
        let playNoteSound = true; // Toggle to enable/disable sound playback
        
        // Chord mode variables
        let chordNotesDetected = []; // Track which notes of the chord have been detected
        let chordStringsPlayed = []; // Track which string indices have been played (to prevent counting same string multiple times)
        let chordModeLevel = 'basic'; // 'basic' or 'complete'
        let chordTypesEnabled = { major: true, minor: true };
        
        // Speed mode variables
        let speedModeActive = false;
        let speedModeTimerInterval = null;
        let speedModeTimeRemaining = 0;
        let speedModeCorrectCount = 0;
        let speedModeStartTime = 0;
        
        // Fretboard state - track which strings are enabled
        let enabledStrings = {};
        
        // Instrument tunings (from low to high string)
        const instrumentTunings = {
            'guitar-6': {
                name: 'Guitare 6 cordes',
                strings: ['E2', 'A2', 'D3', 'G3', 'B3', 'E4'],
                notes: ['E', 'A', 'D', 'G', 'B', 'E'],
                notesFr: ['Mi', 'La', 'R√©', 'Sol', 'Si', 'Mi']
            },
            'guitar-7': {
                name: 'Guitare 7 cordes',
                strings: ['B1', 'E2', 'A2', 'D3', 'G3', 'B3', 'E4'],
                notes: ['B', 'E', 'A', 'D', 'G', 'B', 'E'],
                notesFr: ['Si', 'Mi', 'La', 'R√©', 'Sol', 'Si', 'Mi']
            },
            'bass-4': {
                name: 'Basse 4 cordes',
                strings: ['E1', 'A1', 'D2', 'G2'],
                notes: ['E', 'A', 'D', 'G'],
                notesFr: ['Mi', 'La', 'R√©', 'Sol']
            },
            'bass-5': {
                name: 'Basse 5 cordes',
                strings: ['B0', 'E1', 'A1', 'D2', 'G2'],
                notes: ['B', 'E', 'A', 'D', 'G'],
                notesFr: ['Si', 'Mi', 'La', 'R√©', 'Sol']
            }
        };

        // Elements
        const modeButtons = document.querySelectorAll('.mode-btn');
        const nextBtn = document.getElementById('nextBtn');
        const currentNoteEl = document.getElementById('currentNote');
        const intlNotationEl = document.getElementById('intlNotation');
        const frNotationEl = document.getElementById('frNotation');
        const detectedNoteEl = document.getElementById('detectedNote');
        const enableAudioCheckbox = document.getElementById('enableAudio');
        const audioDetector = document.getElementById('audioDetector');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const advanceDelayInput = document.getElementById('advanceDelay');
        const playSoundCheckbox = document.getElementById('playSoundCheckbox');
        const speedModeDurationInput = document.getElementById('speedModeDuration');
        const speedModeStats = document.getElementById('speedModeStats');
        const speedModeTimer = document.getElementById('speedModeTimer');
        const speedModeScore = document.getElementById('speedModeScore');
        const speedModeStartBtn = document.getElementById('speedModeStartBtn');
        const speedModeDurationDisplay = document.getElementById('speedModeDurationDisplay');
        const showFretboardCheckbox = document.getElementById('showFretboardCheckbox');
        const instrumentSelection = document.getElementById('instrumentSelection');
        const fretCountSelection = document.getElementById('fretCountSelection');
        const instrumentType = document.getElementById('instrumentType');
        const fretCount = document.getElementById('fretCount');
        const fretboardDisplay = document.getElementById('fretboardDisplay');
        const fretboardCanvas = document.getElementById('fretboardCanvas');
        const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const mainGrid = document.getElementById('mainGrid');
        const settingsOverlay = document.getElementById('settingsOverlay');
        const displayPanel = document.querySelector('.display-panel');
        const speedModeSettings = document.getElementById('speedModeSettings');
        const chordsModeSettings = document.getElementById('chordsModeSettings');
        const chordTypeMajor = document.getElementById('chordTypeMajor');
        const chordTypeMinor = document.getElementById('chordTypeMinor');
        const chordsLevel = document.getElementById('chordsLevel');
        const singleNoteDisplay = document.getElementById('singleNoteDisplay');
        const chordNotesDisplay = document.getElementById('chordNotesDisplay');
        const chordNotesValue = document.getElementById('chordNotesValue');
        const chordDiagram = document.getElementById('chordDiagram');
        const controlButtons = document.getElementById('controlButtons');

        // Chord shapes database - format: [fret positions for strings 1-6 (e to E), finger numbers]
        // -1 = muted, 0 = open string
        // Each chord can have multiple positions (array of shapes)
        const chordShapes = {
            'C': [
                { frets: [0, 1, 0, 2, 3, -1], fingers: [0, 1, 0, 2, 3, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [5, 5, 5, 7, 8, 8], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Barr√© en 3' },
                { frets: [8, 8, 9, 10, 10, 8], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 8' }
            ],
            'Cm': [
                { frets: [3, 4, 5, 5, 3, -1], fingers: [1, 2, 4, 3, 1, 0], baseFret: 0, name: 'Barr√© en 3' },
                { frets: [8, 8, 8, 10, 11, 11], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Barr√© en 8' }
            ],
            'C7': [
                { frets: [0, 1, 3, 2, 3, -1], fingers: [0, 1, 4, 2, 3, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [5, 5, 5, 7, 6, 8], fingers: [1, 1, 1, 4, 2, 3], baseFret: 0, name: 'Barr√© en 3' }
            ],
            'CMaj7': [
                { frets: [0, 0, 0, 2, 3, -1], fingers: [0, 0, 0, 2, 3, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Cm7': [
                { frets: [3, 1, 3, 1, 3, -1], fingers: [2, 1, 4, 1, 3, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Cdim': [
                { frets: [2, 4, 2, 4, 3, -1], fingers: [1, 3, 1, 4, 2, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Caug': [
                { frets: [0, 1, 1, 2, 3, -1], fingers: [0, 2, 1, 3, 4, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Csus4': [
                { frets: [1, 1, 0, 3, 3, -1], fingers: [2, 1, 0, 4, 3, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Csus2': [
                { frets: [3, 3, 0, 0, 3, -1], fingers: [4, 3, 0, 0, 2, 0], baseFret: 0, name: 'Position 1' }
            ],
            
            'D': [
                { frets: [2, 3, 2, 0, -1, -1], fingers: [2, 3, 1, 0, 0, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [7, 7, 7, 9, 10, 10], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Barr√© en 5' },
                { frets: [10, 10, 11, 12, 12, 10], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 10' }
            ],
            'Dm': [
                { frets: [1, 3, 2, 0, -1, -1], fingers: [1, 3, 2, 0, 0, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [5, 6, 7, 7, 5, -1], fingers: [1, 2, 4, 3, 1, 0], baseFret: 0, name: 'Barr√© en 5' },
                { frets: [10, 10, 10, 12, 13, 13], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Barr√© en 10' }
            ],
            'D7': [
                { frets: [2, 1, 2, 0, -1, -1], fingers: [3, 1, 2, 0, 0, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [7, 7, 7, 9, 8, 10], fingers: [1, 1, 1, 4, 2, 3], baseFret: 0, name: 'Barr√© en 5' }
            ],
            'DMaj7': [
                { frets: [2, 2, 2, 0, -1, -1], fingers: [1, 1, 1, 0, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Dm7': [
                { frets: [1, 1, 2, 0, -1, -1], fingers: [1, 1, 2, 0, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Ddim': [
                { frets: [1, 0, 1, 0, -1, -1], fingers: [2, 0, 1, 0, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Daug': [
                { frets: [2, 3, 3, 0, -1, -1], fingers: [1, 3, 2, 0, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Dsus4': [
                { frets: [3, 3, 2, 0, -1, -1], fingers: [4, 3, 1, 0, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Dsus2': [
                { frets: [0, 3, 2, 0, -1, -1], fingers: [0, 2, 1, 0, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            
            'E': [
                { frets: [0, 0, 1, 2, 2, 0], fingers: [0, 0, 1, 3, 2, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [4, 4, 5, 6, 6, 4], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 4' },
                { frets: [7, 7, 9, 9, 9, 7], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 7' }
            ],
            'Em': [
                { frets: [0, 0, 0, 2, 2, 0], fingers: [0, 0, 0, 3, 2, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [7, 8, 9, 9, 7, -1], fingers: [1, 2, 4, 3, 1, 0], baseFret: 0, name: 'Barr√© en 7' },
                { frets: [12, 12, 12, 14, 15, 15], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Barr√© en 12' }
            ],
            'E7': [
                { frets: [0, 0, 1, 0, 2, 0], fingers: [0, 0, 1, 0, 2, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [7, 7, 7, 9, 8, 10], fingers: [1, 1, 1, 4, 2, 3], baseFret: 0, name: 'Barr√© en 7' }
            ],
            'EMaj7': [
                { frets: [0, 0, 1, 1, 2, 0], fingers: [0, 0, 2, 1, 3, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Em7': [
                { frets: [0, 0, 0, 0, 2, 0], fingers: [0, 0, 0, 0, 2, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Edim': [
                { frets: [0, 2, 0, 2, 1, 0], fingers: [0, 4, 0, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Eaug': [
                { frets: [0, 1, 1, 2, 3, 0], fingers: [0, 2, 1, 3, 4, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Esus4': [
                { frets: [0, 0, 2, 2, 2, 0], fingers: [0, 0, 4, 3, 2, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Esus2': [
                { frets: [2, 5, 4, 2, 2, 0], fingers: [1, 3, 2, 1, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            
            'G': [
                { frets: [3, 0, 0, 0, 2, 3], fingers: [3, 0, 0, 0, 1, 2], baseFret: 0, name: 'Position ouverte' },
                { frets: [3, 2, 0, 0, 0, 3], fingers: [2, 1, 0, 0, 0, 3], baseFret: 0, name: 'Position ouverte alt.' },
                { frets: [10, 10, 10, 12, 13, 13], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Barr√© en 10' }
            ],
            'Gm': [
                { frets: [3, 3, 3, 5, 5, 3], fingers: [1, 1, 1, 4, 3, 1], baseFret: 0, name: 'Barr√© en 3' },
                { frets: [10, 11, 12, 12, 10, -1], fingers: [1, 2, 4, 3, 1, 0], baseFret: 0, name: 'Barr√© en 10' }
            ],
            'G7': [
                { frets: [1, 0, 0, 0, 2, 3], fingers: [1, 0, 0, 0, 2, 3], baseFret: 0, name: 'Position ouverte' },
                { frets: [3, 2, 3, 0, 0, 1], fingers: [3, 2, 4, 0, 0, 1], baseFret: 0, name: 'Position ouverte alt.' },
                { frets: [10, 10, 10, 12, 11, 13], fingers: [1, 1, 1, 4, 2, 3], baseFret: 0, name: 'Barr√© en 10' }
            ],
            'GMaj7': [
                { frets: [2, 0, 0, 0, 2, 3], fingers: [2, 0, 0, 0, 1, 3], baseFret: 0, name: 'Position 1' }
            ],
            'Gm7': [
                { frets: [3, 3, 3, 3, 5, 3], fingers: [1, 1, 1, 1, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'Gdim': [
                { frets: [3, 5, 3, 5, 4, 3], fingers: [1, 3, 1, 4, 2, 1], baseFret: 0, name: 'Position 1' }
            ],
            'Gaug': [
                { frets: [3, 0, 0, 1, 2, 3], fingers: [4, 0, 0, 1, 2, 3], baseFret: 0, name: 'Position 1' }
            ],
            'Gsus4': [
                { frets: [3, 1, 0, 0, 3, 3], fingers: [4, 1, 0, 0, 3, 2], baseFret: 0, name: 'Position 1' }
            ],
            'Gsus2': [
                { frets: [3, 3, 0, 0, 0, 3], fingers: [4, 3, 0, 0, 0, 2], baseFret: 0, name: 'Position 1' }
            ],
            
            'A': [
                { frets: [0, 2, 2, 2, 0, -1], fingers: [0, 3, 2, 1, 0, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [5, 5, 6, 7, 7, 5], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 5' },
                { frets: [9, 9, 11, 11, 11, 9], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 9' }
            ],
            'Am': [
                { frets: [0, 1, 2, 2, 0, -1], fingers: [0, 1, 3, 2, 0, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [5, 5, 5, 7, 8, 8], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Barr√© en 5' },
                { frets: [12, 12, 13, 14, 14, 12], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 12' }
            ],
            'A7': [
                { frets: [0, 2, 0, 2, 0, -1], fingers: [0, 3, 0, 2, 0, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [5, 5, 5, 7, 6, 8], fingers: [1, 1, 1, 4, 2, 3], baseFret: 0, name: 'Barr√© en 5' }
            ],
            'AMaj7': [
                { frets: [0, 2, 1, 2, 0, -1], fingers: [0, 3, 1, 2, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Am7': [
                { frets: [0, 1, 0, 2, 0, -1], fingers: [0, 1, 0, 2, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Adim': [
                { frets: [2, 1, 2, 1, 0, -1], fingers: [4, 2, 3, 1, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Aaug': [
                { frets: [1, 2, 2, 3, 0, -1], fingers: [1, 3, 2, 4, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Asus4': [
                { frets: [0, 3, 2, 2, 0, -1], fingers: [0, 3, 2, 1, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Asus2': [
                { frets: [0, 0, 2, 2, 0, -1], fingers: [0, 0, 2, 1, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            
            // Barr√© chords for other notes
            'F': [
                { frets: [1, 1, 2, 3, 3, 1], fingers: [1, 1, 2, 4, 3, 1], baseFret: 0, name: 'Barr√© en 1' },
                { frets: [5, 5, 5, 7, 8, 8], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Barr√© en 5' },
                { frets: [8, 8, 10, 10, 10, 8], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 8' }
            ],
            'Fm': [
                { frets: [1, 1, 1, 3, 3, 1], fingers: [1, 1, 1, 4, 3, 1], baseFret: 0, name: 'Barr√© en 1' },
                { frets: [8, 9, 10, 10, 8, -1], fingers: [1, 2, 4, 3, 1, 0], baseFret: 0, name: 'Barr√© en 8' }
            ],
            'F7': [
                { frets: [1, 1, 2, 1, 3, 1], fingers: [1, 1, 2, 1, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'FMaj7': [
                { frets: [1, 1, 2, 2, 3, 1], fingers: [1, 1, 2, 2, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'Fm7': [
                { frets: [1, 1, 1, 1, 3, 1], fingers: [1, 1, 1, 1, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'Fdim': [
                { frets: [1, 3, 1, 3, 2, 1], fingers: [1, 3, 1, 4, 2, 1], baseFret: 0, name: 'Position 1' }
            ],
            'Faug': [
                { frets: [1, 2, 2, 3, 0, 1], fingers: [1, 3, 2, 4, 0, 1], baseFret: 0, name: 'Position 1' }
            ],
            'Fsus4': [
                { frets: [1, 1, 3, 3, 3, 1], fingers: [1, 1, 4, 4, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'Fsus2': [
                { frets: [1, 1, 0, 3, 3, 1], fingers: [1, 1, 0, 4, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            
            'B': [
                { frets: [2, 4, 4, 4, 2, -1], fingers: [1, 3, 3, 3, 1, 0], baseFret: 0, name: 'Barr√© en 2' },
                { frets: [7, 7, 8, 9, 9, 7], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 7' },
                { frets: [11, 11, 13, 13, 13, 11], fingers: [1, 1, 2, 3, 4, 1], baseFret: 0, name: 'Barr√© en 11' }
            ],
            'Bm': [
                { frets: [2, 3, 4, 4, 2, -1], fingers: [1, 2, 4, 3, 1, 0], baseFret: 0, name: 'Barr√© en 2' },
                { frets: [7, 7, 7, 9, 10, 10], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Barr√© en 7' }
            ],
            'B7': [
                { frets: [2, 0, 2, 1, 2, -1], fingers: [4, 0, 3, 1, 2, 0], baseFret: 0, name: 'Position ouverte' },
                { frets: [7, 7, 7, 9, 8, 10], fingers: [1, 1, 1, 4, 2, 3], baseFret: 0, name: 'Barr√© en 7' }
            ],
            'BMaj7': [
                { frets: [2, 4, 3, 4, 2, -1], fingers: [1, 4, 2, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Bm7': [
                { frets: [2, 3, 2, 4, 2, -1], fingers: [1, 2, 1, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Bdim': [
                { frets: [4, 3, 4, 3, 2, -1], fingers: [3, 2, 4, 2, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Baug': [
                { frets: [3, 0, 0, 1, 2, -1], fingers: [4, 0, 0, 1, 2, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Bsus4': [
                { frets: [2, 5, 4, 4, 2, -1], fingers: [1, 4, 3, 2, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'Bsus2': [
                { frets: [2, 2, 4, 4, 2, -1], fingers: [1, 1, 4, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            
            // C# / Db chords (barr√© at fret 4 or 1)
            'C#': [
                { frets: [1, 1, 1, 3, 4, 4], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Position 1' }
            ],
            'C#m': [
                { frets: [1, 1, 2, 4, 4, 4], fingers: [1, 1, 2, 3, 3, 3], baseFret: 0, name: 'Position 1' }
            ],
            'C#7': [
                { frets: [1, 1, 1, 3, 2, 4], fingers: [1, 1, 1, 4, 2, 3], baseFret: 0, name: 'Position 1' }
            ],
            'C#Maj7': [
                { frets: [1, 1, 1, 3, 3, 3], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Position 1' }
            ],
            'C#m7': [
                { frets: [1, 1, 2, 4, 2, 4], fingers: [1, 1, 2, 4, 2, 3], baseFret: 0, name: 'Position 1' }
            ],
            'C#dim': [
                { frets: [0, 1, 2, 0, 2, 0], fingers: [0, 1, 3, 0, 4, 0], baseFret: 0, name: 'Position 1' }
            ],
            'C#aug': [
                { frets: [1, 2, 2, 3, 4, -1], fingers: [1, 2, 2, 3, 4, 0], baseFret: 0, name: 'Position 1' }
            ],
            'C#sus4': [
                { frets: [1, 1, 1, 4, 4, 4], fingers: [1, 1, 1, 2, 3, 4], baseFret: 0, name: 'Position 1' }
            ],
            'C#sus2': [
                { frets: [1, 1, 1, 1, 4, 4], fingers: [1, 1, 1, 1, 3, 4], baseFret: 0, name: 'Position 1' }
            ],
            
            // D# / Eb chords (barr√© at fret 6 or shapes based on D)
            'D#': [
                { frets: [3, 6, 5, 3, -1, -1], fingers: [1, 4, 3, 2, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'D#m': [
                { frets: [3, 6, 6, 3, -1, -1], fingers: [1, 3, 4, 2, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'D#7': [
                { frets: [3, 4, 3, 3, -1, -1], fingers: [2, 4, 3, 1, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'D#Maj7': [
                { frets: [3, 5, 4, 4, -1, -1], fingers: [1, 4, 2, 3, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'D#m7': [
                { frets: [3, 4, 3, 4, -1, -1], fingers: [2, 3, 1, 4, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'D#dim': [
                { frets: [3, 4, 2, 3, -1, -1], fingers: [2, 4, 1, 3, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'D#aug': [
                { frets: [3, 2, 1, 0, 0, 3], fingers: [4, 3, 2, 0, 0, 1], baseFret: 0, name: 'Position 1' }
            ],
            'D#sus4': [
                { frets: [3, 3, 4, 3, -1, -1], fingers: [1, 2, 4, 3, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            'D#sus2': [
                { frets: [3, 3, 3, 5, -1, -1], fingers: [1, 1, 1, 3, 0, 0], baseFret: 0, name: 'Position 1' }
            ],
            
            // F# / Gb chords (barr√© at fret 2)
            'F#': [
                { frets: [2, 2, 3, 4, 4, 2], fingers: [1, 1, 2, 4, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'F#m': [
                { frets: [2, 2, 2, 4, 4, 2], fingers: [1, 1, 1, 3, 4, 1], baseFret: 0, name: 'Position 1' }
            ],
            'F#7': [
                { frets: [2, 2, 3, 2, 4, 2], fingers: [1, 1, 3, 1, 4, 1], baseFret: 0, name: 'Position 1' }
            ],
            'F#Maj7': [
                { frets: [2, 2, 3, 3, 4, 2], fingers: [1, 1, 2, 2, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'F#m7': [
                { frets: [2, 2, 2, 2, 4, 2], fingers: [1, 1, 1, 1, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'F#dim': [
                { frets: [2, 3, 4, 2, 4, 2], fingers: [1, 2, 4, 1, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'F#aug': [
                { frets: [2, 1, 4, 3, 3, 2], fingers: [2, 1, 4, 3, 3, 2], baseFret: 0, name: 'Position 1' }
            ],
            'F#sus4': [
                { frets: [2, 2, 4, 4, 4, 2], fingers: [1, 1, 3, 3, 4, 1], baseFret: 0, name: 'Position 1' }
            ],
            'F#sus2': [
                { frets: [2, 2, 1, 4, 4, 2], fingers: [2, 2, 1, 3, 4, 2], baseFret: 0, name: 'Position 1' }
            ],
            
            // G# / Ab chords (barr√© at fret 4)
            'G#': [
                { frets: [4, 1, 1, 1, 3, 4], fingers: [3, 1, 1, 1, 2, 4], baseFret: 0, name: 'Position 1' }
            ],
            'G#m': [
                { frets: [4, 4, 4, 6, 6, 4], fingers: [1, 1, 1, 3, 4, 1], baseFret: 0, name: 'Position 1' }
            ],
            'G#7': [
                { frets: [4, 1, 1, 1, 2, 4], fingers: [3, 1, 1, 1, 2, 4], baseFret: 0, name: 'Position 1' }
            ],
            'G#Maj7': [
                { frets: [4, 1, 1, 1, 1, 4], fingers: [3, 1, 1, 1, 1, 4], baseFret: 0, name: 'Position 1' }
            ],
            'G#m7': [
                { frets: [4, 4, 4, 4, 6, 4], fingers: [1, 1, 1, 1, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'G#dim': [
                { frets: [4, 5, 6, 4, 6, 4], fingers: [1, 2, 4, 1, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'G#aug': [
                { frets: [4, 3, 2, 1, 1, 0], fingers: [4, 3, 2, 1, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'G#sus4': [
                { frets: [4, 4, 1, 1, 2, 4], fingers: [3, 4, 1, 1, 2, 3], baseFret: 0, name: 'Position 1' }
            ],
            'G#sus2': [
                { frets: [4, 4, 1, 1, 4, 4], fingers: [2, 3, 1, 1, 4, 4], baseFret: 0, name: 'Position 1' }
            ],
            
            // A# / Bb chords (barr√© at fret 1)
            'A#': [
                { frets: [1, 3, 3, 3, 1, -1], fingers: [1, 3, 3, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'A#m': [
                { frets: [1, 2, 3, 3, 1, -1], fingers: [1, 2, 4, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'A#7': [
                { frets: [1, 3, 1, 3, 1, -1], fingers: [1, 3, 1, 4, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'A#Maj7': [
                { frets: [1, 3, 2, 3, 1, -1], fingers: [1, 4, 2, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'A#m7': [
                { frets: [1, 2, 1, 3, 1, -1], fingers: [1, 2, 1, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'A#dim': [
                { frets: [1, 2, 3, 2, 1, -1], fingers: [1, 2, 4, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'A#aug': [
                { frets: [1, 0, 3, 2, 2, 1], fingers: [1, 0, 4, 2, 3, 1], baseFret: 0, name: 'Position 1' }
            ],
            'A#sus4': [
                { frets: [1, 3, 3, 3, 1, -1], fingers: [1, 3, 3, 3, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
            'A#sus2': [
                { frets: [1, 1, 3, 3, 1, -1], fingers: [1, 1, 3, 4, 1, 0], baseFret: 0, name: 'Position 1' }
            ],
        };

        // Mode selection
        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                modeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                // Reset pools when changing mode
                availableNotes = [];
                availableChords = [];
                chordNotesDetected = [];
                
                // Show/hide mode-specific UI
                if (currentMode === 'speed') {
                    speedModeStats.style.display = 'block';
                    speedModeSettings.style.display = 'block';
                    chordsModeSettings.style.display = 'none';
                    controlButtons.style.display = 'none';
                    singleNoteDisplay.style.display = 'block';
                    chordNotesDisplay.style.display = 'none';
                    stopSpeedMode();
                } else if (currentMode === 'chords') {
                    speedModeStats.style.display = 'none';
                    speedModeSettings.style.display = 'none';
                    chordsModeSettings.style.display = 'block';
                    controlButtons.style.display = 'flex';
                    singleNoteDisplay.style.display = 'block'; // Show for chord name display
                    chordNotesDisplay.style.display = 'block'; // Show chord notes info
                    stopSpeedMode();
                } else {
                    speedModeStats.style.display = 'none';
                    speedModeSettings.style.display = 'none';
                    chordsModeSettings.style.display = 'none';
                    controlButtons.style.display = 'flex';
                    singleNoteDisplay.style.display = 'block';
                    chordNotesDisplay.style.display = 'none';
                    stopSpeedMode();
                }
                
                generateExercise();
            });
        });

        // Difficulty selection
        const difficultyButtons = document.querySelectorAll('.difficulty-btn');
        difficultyButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                difficultyButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentDifficulty = btn.dataset.difficulty;
                // Reset pools when changing difficulty
                availableNotes = [];
                
                generateExercise();
            });
        });

        // Generate exercise
        function initializeNotesPool() {
            // Use notes based on current difficulty level
            const level = difficultyLevels[currentDifficulty];
            
            if (currentDifficulty === 'expert') {
                // Expert mode: return all note-string combinations
                const combinations = [];
                level.notes.forEach(noteObj => {
                    noteObj.strings.forEach(stringInfo => {
                        combinations.push({ 
                            note: noteObj.note, 
                            string: stringInfo 
                        });
                    });
                });
                return combinations;
            } else {
                // Other modes: simple note list
                return level.notes.map(note => ({ note }));
            }
        }

        function initializeChordsPool() {
            // Build list of chords based on level and selected types
            const level = chordsLevel.value; // 'basic' or 'complete'
            const includeMajor = chordTypeMajor.checked;
            const includeMinor = chordTypeMinor.checked;
            
            if (!includeMajor && !includeMinor) {
                return []; // No types selected
            }
            
            let chordsList = [];
            
            if (level === 'basic') {
                // Basic chords: C, D, E, G, A, Am, Dm, Em
                if (includeMajor) {
                    chordsList.push('C', 'D', 'E', 'G', 'A');
                }
                if (includeMinor) {
                    chordsList.push('Am', 'Dm', 'Em');
                }
            } else {
                // Complete: all chords in database
                if (includeMajor) {
                    chordsList.push('C', 'D', 'E', 'F', 'G', 'A', 'B');
                }
                if (includeMinor) {
                    chordsList.push('Am', 'Bm', 'Cm', 'Dm', 'Em', 'Fm', 'Gm');
                }
            }
            
            return chordsList;
        }

        function getRandomNote() {
            // Initialize pool if empty or first time
            if (availableNotes.length === 0) {
                availableNotes = initializeNotesPool();
                // Shuffle the array
                for (let i = availableNotes.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [availableNotes[i], availableNotes[j]] = [availableNotes[j], availableNotes[i]];
                }
            }
            
            // Pick and remove the first note from available pool
            const noteObj = availableNotes.shift();
            
            // Return object with note and string info (for expert mode)
            if (currentDifficulty === 'expert' && noteObj.string) {
                return { note: noteObj.note, string: noteObj.string };
            } else {
                return { note: noteObj.note };
            }
        }

        function getRandomChord() {
            // Initialize pool if empty or first time
            if (availableChords.length === 0) {
                availableChords = initializeChordsPool();
                // Shuffle the array
                for (let i = availableChords.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [availableChords[i], availableChords[j]] = [availableChords[j], availableChords[i]];
                }
            }
            
            // Pick and remove the first chord from available pool
            const chord = availableChords.shift();
            return chord;
        }

        function generateExercise() {
            const selectedStrings = ['E4', 'B3', 'G3', 'D3', 'A2', 'E2'];
            const minFret = 0;
            const maxFret = 12;

            if (currentMode === 'single' || currentMode === 'speed') {
                // Both single and speed modes use single notes
                generateSingleNote(selectedStrings, minFret, maxFret);
            } else if (currentMode === 'chords') {
                generateChord();
            }

            // Don't update display immediately if audio is active and a note is being played
            if (isListening && lastDetectedNote !== null) {
                // Wait for note to be released before showing new exercise
                waitingForRelease = true;
                // Hide the current note while waiting
                currentNoteEl.textContent = '‚Äî';
                intlNotationEl.textContent = '‚Äî';
                frNotationEl.textContent = '‚Äî';
            } else {
                // No note being played, show immediately
                updateDisplay();
                waitingForRelease = false;
            }
            
            // Reset detected note display when changing exercise
            if (isListening) {
                if (waitingForRelease) {
                    // Show message to release the note
                    detectedNoteEl.textContent = 'Rel√¢chez la note pour passer √† la suivante';
                    detectedNoteEl.className = 'detected-note';
                } else {
                    detectedNoteEl.textContent = '‚Äî';
                    detectedNoteEl.className = 'detected-note';
                }
                lastDetectedNote = null;
                noteDetectionStartTime = 0;
                hasAutoAdvanced = false;
            }
        }






        function generateSingleNote(strings, minFret, maxFret) {
            const noteObj = getRandomNote();
            
            currentExercise = {
                type: 'single',
                notes: [noteObj],
                difficulty: currentDifficulty
            };
        }

        function generateChord() {
            const chordName = getRandomChord();
            
            if (!chordName || !chordDiagrams[chordName]) {
                console.error('Chord not found:', chordName);
                return;
            }
            
            const chordData = chordDiagrams[chordName];
            const instrument = instrumentTunings[instrumentType.value];
            const numStrings = instrument.strings.length;
            
            // Adapt chord to current instrument (truncate or extend)
            let adaptedFrets = [...chordData.frets];
            let adaptedFingers = [...chordData.fingers];
            
            if (numStrings > adaptedFrets.length) {
                // Add extra low strings (muted by default)
                const extraStrings = numStrings - adaptedFrets.length;
                for (let i = 0; i < extraStrings; i++) {
                    adaptedFrets.push(-1); // Mute extra strings
                    adaptedFingers.push(0);
                }
            } else if (numStrings < adaptedFrets.length) {
                // Remove high strings to fit instrument
                adaptedFrets = adaptedFrets.slice(0, numStrings);
                adaptedFingers = adaptedFingers.slice(0, numStrings);
            }
            
            // Count how many strings should be played (not muted = not -1)
            const stringsToPlay = adaptedFrets.filter(f => f !== -1).length;
            
            currentExercise = {
                type: 'chord',
                chord: {
                    name: chordName,
                    displayName: chordData.name,
                    notes: chordData.notes,
                    frets: adaptedFrets,
                    fingers: adaptedFingers,
                    stringsToPlay: stringsToPlay // Total strings that must be played
                }
            };
            
            // Reset detection tracking
            chordNotesDetected = [];
            chordStringsPlayed = [];
        }

        function updateDisplay() {
            if (!currentExercise) return;

            if (currentExercise.type === 'single') {
                const noteObj = currentExercise.notes[0];
                const note = noteObj.note;
                
                // Display note name
                currentNoteEl.textContent = note;
                intlNotationEl.textContent = note;
                frNotationEl.textContent = noteToFrench[note];
                
                // For expert mode, show string info
                if (currentExercise.difficulty === 'expert' && noteObj.string) {
                    const stringDisplay = noteObj.string.replace(/([A-G]\d+)-?(\d*)/, (match, string, fret) => {
                        if (fret) {
                            return `Corde ${string} - Frette ${fret}`;
                        } else {
                            return `Corde ${string} √† vide`;
                        }
                    });
                    frNotationEl.textContent = noteToFrench[note] + ` (${stringDisplay})`;
                }
                
                // Draw fretboard if enabled
                drawFretboard(note);
                
                // Play the note sound
                playNote(note);
            } else if (currentExercise.type === 'chord') {
                // Display chord name in main display (like single notes)
                const chord = currentExercise.chord;
                currentNoteEl.textContent = chord.name;
                
                // Display chord notes in notation sections
                intlNotationEl.textContent = chord.notes.join(' - ');
                frNotationEl.textContent = chord.notes.map(n => noteToFrench[n]).join(' - ');
                
                // Show progress in the chord notes area
                const progressText = `${chordNotesDetected.length}/${chord.stringsToPlay} cordes jou√©es`;
                const notesList = chordNotesDetected.length > 0 ? ` (${[...new Set(chordNotesDetected)].join(', ')})` : '';
                chordNotesValue.textContent = progressText + notesList;
                
                // Draw chord diagram on fretboard if enabled
                drawChordFretboard(chord);
            }
        }

        function drawChordFretboard(chord) {
            // Only display if checkbox is enabled (same as drawFretboard)
            if (!showFretboardCheckbox.checked) {
                fretboardDisplay.style.display = 'none';
                return;
            }
            
            fretboardDisplay.style.display = 'block';
            
            // Use same styling as drawFretboard
            const instrument = instrumentTunings[instrumentType.value];
            const numStrings = instrument.strings.length;
            
            // Get chord frets and fingers
            const frets = chord.frets;
            const fingers = chord.fingers;
            
            // Helper function to get the note at a given string and fret
            const getNoteAtPosition = (stringIndex, fretNum) => {
                const openNote = instrument.notes[stringIndex];
                const openNoteIndex = allNotes.indexOf(openNote);
                const noteIndex = (openNoteIndex + fretNum) % 12;
                return allNotes[noteIndex];
            };
            
            // Calculate the range needed for this chord
            const hasOpenStrings = frets.some(f => f === 0); // Check for open strings
            const playedFrets = frets.filter(f => f > 0); // Exclude muted (-1) and open (0)
            const minFret = playedFrets.length > 0 ? Math.min(...playedFrets) : 0;
            const maxFret = playedFrets.length > 0 ? Math.max(...playedFrets) : 3;
            
            // Determine start and end frets to display (show 5-6 frets total)
            let startFret = 0;
            let endFret = 5;
            
            if (hasOpenStrings) {
                // If there are open strings, always start from fret 0
                startFret = 0;
                endFret = Math.max(5, maxFret + 1);
            } else if (minFret > 0) {
                // For barre chords without open strings, show from minFret-1
                startFret = Math.max(0, minFret - 1);
                endFret = Math.min(24, Math.max(startFret + 5, maxFret + 1));
            }
            
            const numFrets = endFret - startFret;
            
            // Fixed cell width for chord display (always 50px for clarity)
            const cellWidth = 50;
            const minWidth = (numFrets + 1) * cellWidth + 60; // +60 for string names
            
            
            // Build HTML for fretboard (same structure as drawFretboard)
            let html = `<div style="display: inline-block; min-width: ${minWidth}px; width: max-content;">`;
            
            // Fret numbers header
            html += '<div style="display: flex; align-items: center; margin-bottom: 0.25rem;">';
            html += '<div style="width: 50px;"></div>'; // Spacing for string names
            
            for (let fret = startFret; fret <= endFret; fret++) {
                html += `<div style="width: ${cellWidth}px; text-align: center; font-size: 0.7rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">${fret}</div>`;
            }
            html += '</div>';
            
            // Draw strings (from high to low for visual clarity)
            for (let s = numStrings - 1; s >= 0; s--) {
                html += '<div style="display: flex; align-items: center; margin-bottom: 0.5rem;">';
                
                // String name - French notation
                const stringNoteFr = instrument.notesFr[s];
                const stringNum = instrument.strings[s].match(/\d+/)[0]; // Extract octave number
                
                // Check if string is muted for this chord
                const isMuted = frets[s] === -1;
                const stringColor = isMuted ? 'var(--accent-danger)' : 'var(--accent-primary)';
                
                html += `<div style="width: 50px; text-align: right; padding-right: 0.5rem; font-size: 0.8rem; color: ${stringColor}; font-family: 'JetBrains Mono', monospace; user-select: none;">${stringNoteFr}${stringNum}</div>`;
                
                // Frets
                for (let f = startFret; f <= endFret; f++) {
                    // Check if this is a chord position
                    const isChordPosition = frets[s] === f;
                    const fingerNum = isChordPosition ? fingers[s] : 0;
                    
                    // Check if this string has been played (for color highlighting)
                    const isDetected = isChordPosition && chordStringsPlayed.includes(s);
                    
                    // Use green if detected, cyan if not yet detected
                    const positionColor = isDetected ? 'var(--success)' : 'var(--accent-primary)';
                    const bgColor = isChordPosition ? positionColor : (f === startFret ? 'var(--bg-primary)' : 'transparent');
                    const borderColor = f === startFret ? 'var(--border)' : 'var(--text-secondary)';
                    const size = isChordPosition ? '24px' : '10px';
                    const glowColor = isDetected ? 'var(--success)' : 'var(--accent-primary)';
                    
                    html += `<div style="width: ${cellWidth}px; height: 30px; display: flex; align-items: center; justify-content: center; border-left: ${f === startFret ? '3' : '1'}px solid ${borderColor}; position: relative;">`;
                    
                    // Chord position - show finger number or open string
                    if (isChordPosition) {
                        if (fingerNum === 0 && f === 0) {
                            // Open string - use a ring (green if detected)
                            html += `<div style="width: ${size}; height: ${size}; border-radius: 50%; background: transparent; border: 3px solid ${positionColor}; box-shadow: 0 0 10px ${glowColor};"></div>`;
                        } else {
                            // Fingered position - solid circle with number (green if detected)
                            html += `<div style="width: ${size}; height: ${size}; border-radius: 50%; background: ${bgColor}; box-shadow: 0 0 10px ${glowColor}; border: 2px solid var(--bg-primary); display: flex; align-items: center; justify-content: center; color: var(--bg-primary); font-weight: 700; font-size: 0.8rem;">${fingerNum}</div>`;
                        }
                    }
                    // Muted string at nut
                    else if (isMuted && f === startFret && startFret === 0) {
                        html += `<div style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; color: var(--accent-danger); font-weight: 700; font-size: 1.2rem;">‚úï</div>`;
                    }
                    // Fret markers (only for relevant frets in the range)
                    else if (f > 0) {
                        const standardMarkers = [3, 5, 7, 9, 12, 15, 17, 19, 21, 24];
                        const doubleMarkers = [12, 24];
                        
                        if (standardMarkers.includes(f) && s === Math.floor(numStrings / 2)) {
                            html += `<div style="width: 6px; height: 6px; border-radius: 50%; background: var(--text-secondary); opacity: 0.3;"></div>`;
                        } else if (doubleMarkers.includes(f) && (s === Math.floor(numStrings / 2) || s === Math.floor(numStrings / 2) - 1)) {
                            html += `<div style="width: 6px; height: 6px; border-radius: 50%; background: var(--text-secondary); opacity: 0.3;"></div>`;
                        }
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            
            // Info display (same style as drawFretboard)
            html += `<div style="margin-top: 0.75rem; text-align: center; font-size: 0.85rem; color: var(--accent-primary); font-family: 'JetBrains Mono', monospace;">`;
            if (startFret === 0) {
                html += `Position de l'accord (cases 0-${endFret})`;
            } else {
                html += `Position de l'accord (cases ${startFret}-${endFret})`;
            }
            html += '</div>';
            
            // Legend
            html += `<div style="margin-top: 0.5rem; text-align: center; font-size: 0.75rem; color: var(--text-secondary); font-style: italic;">`;
            html += `üí° <span style="color: var(--accent-primary);">‚¨§ 1-4</span> = Doigt | <span style="color: var(--success);">‚óØ</span> = Corde √† vide | <span style="color: var(--accent-danger);">‚úï</span> = Muette`;
            html += '</div>';
            
            fretboardCanvas.innerHTML = html;
        }

        // Audio detection
        async function startAudioDetection() {
            try {
                // Only request microphone access if we don't have it yet
                if (!microphoneStream) {
                    microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    microphonePermissionGranted = true;
                }
                
                // Create new audio context if needed
                if (!audioContext || audioContext.state === 'closed') {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Create analyser and microphone node
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(microphoneStream);
                
                analyser.fftSize = 4096;
                microphone.connect(analyser);
                
                isListening = true;
                statusIndicator.classList.add('active');
                statusText.textContent = 'Microphone actif';
                
                detectPitch();
                
                // Request wake lock to prevent screen from sleeping
                if ('wakeLock' in navigator) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Wake Lock activ√© - l\'√©cran ne se mettra pas en veille');
                    } catch (err) {
                        console.log('Wake Lock non disponible:', err);
                    }
                }
            } catch (err) {
                console.error('Erreur microphone:', err);
                alert('Impossible d\'acc√©der au microphone');
                enableAudioCheckbox.checked = false;
                microphonePermissionGranted = false;
            }
        }

        function stopAudioDetection(fullStop = false) {
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // Only stop the stream if explicitly requested (checkbox unchecked)
            if (fullStop && microphoneStream) {
                microphoneStream.getTracks().forEach(track => track.stop());
                microphoneStream = null;
                microphonePermissionGranted = false;
            }
            
            isListening = false;
            statusIndicator.classList.remove('active');
            statusText.textContent = 'Microphone d√©sactiv√©';
            detectedNoteEl.textContent = '‚Äî';
            detectedNoteEl.className = 'detected-note';
            lastDetectedNote = null;
            noteDetectionStartTime = 0;
            
            // Release wake lock
            if (wakeLock !== null) {
                wakeLock.release()
                    .then(() => {
                        wakeLock = null;
                        console.log('Wake Lock d√©sactiv√©');
                    });
            }
        }

        function detectPitch() {
            if (!isListening) return;
            
            const bufferLength = analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(buffer);
            
            const frequency = autoCorrelate(buffer, audioContext.sampleRate);
            
            // If waiting for release, don't update detection display
            if (waitingForRelease) {
                if (frequency <= 0) {
                    // Note released, show new exercise
                    waitingForRelease = false;
                    updateDisplay();
                    detectedNoteEl.textContent = '‚Äî';
                    detectedNoteEl.className = 'detected-note';
                    lastDetectedNote = null;
                    noteDetectionStartTime = 0;
                }
                requestAnimationFrame(detectPitch);
                return;
            }
            
            if (frequency > 0) {
                const note = frequencyToNote(frequency);
                const currentTime = Date.now();
                
                // Check if the note has changed
                if (note !== lastDetectedNote) {
                    // New note detected, reset timer and clear display
                    lastDetectedNote = note;
                    noteDetectionStartTime = currentTime;
                    hasAutoAdvanced = false; // Reset for new note (important for chord mode)
                    detectedNoteEl.textContent = '‚Äî';
                    detectedNoteEl.className = 'detected-note';
                } else {
                    // Same note, check if it's been stable
                    const elapsedTime = currentTime - noteDetectionStartTime;
                    
                    // Use shorter duration for chord mode (50ms) to detect fast strumming
                    const requiredDuration = (currentExercise && currentExercise.type === 'chord') ? 50 : stableNoteDuration;
                    
                    if (elapsedTime >= requiredDuration) {
                        // Note has been stable long enough, display it
                        detectedNoteEl.textContent = `${note} (${noteToFrench[note]})`;
                        
                        // Check if correct
                        if (currentExercise && currentExercise.type === 'single') {
                            if (note === currentExercise.notes[0].note) {
                                detectedNoteEl.className = 'detected-note correct';
                                
                                // Auto-advance to next note after a short delay (only once)
                                if (!hasAutoAdvanced) {
                                    hasAutoAdvanced = true;
                                    
                                    // Increment speed mode score (only once per note)
                                    incrementSpeedModeScore();
                                    
                                    const delayMs = speedModeActive ? 500 : parseFloat(advanceDelayInput.value) * 1000;
                                    setTimeout(() => {
                                        if (isListening) { // Only if still listening
                                            generateExercise();
                                            hasAutoAdvanced = false; // Reset for next note
                                        }
                                    }, delayMs);
                                }
                            } else {
                                detectedNoteEl.className = 'detected-note incorrect';
                                // Reset hasAutoAdvanced to allow detection to continue
                                hasAutoAdvanced = false;
                            }
                        } else if (currentExercise && currentExercise.type === 'chord') {
                            // Chord mode: check if note is part of the chord
                            const chordNotes = currentExercise.chord.notes;
                            const stringsToPlay = currentExercise.chord.stringsToPlay;
                            const frets = currentExercise.chord.frets;
                            
                            if (chordNotes.includes(note)) {
                                // Correct note from the chord
                                detectedNoteEl.className = 'detected-note correct';
                                
                                // Only increment once per note detection (use hasAutoAdvanced to prevent multiple counts)
                                if (!hasAutoAdvanced && chordStringsPlayed.length < stringsToPlay) {
                                    hasAutoAdvanced = true; // Prevent counting again for same note
                                    
                                    // Find the next expected string (from low to high: index 5 ‚Üí 0)
                                    // Start from the lowest string (highest index) and go up
                                    const instrument = instrumentTunings[instrumentType.value];
                                    let stringFound = false;
                                    
                                    // Find next string to play (from low to high pitch: index 0 ‚Üí 5)
                                    // Index 0 = lowest pitch (E2 grave), Index 5 = highest pitch (E4 aigu)
                                    let nextStringIndex = -1;
                                    for (let s = 0; s < frets.length; s++) {
                                        if (frets[s] !== -1 && !chordStringsPlayed.includes(s)) {
                                            nextStringIndex = s;
                                            break;
                                        }
                                    }
                                    
                                    // Check if the detected note matches the next expected string
                                    if (nextStringIndex >= 0) {
                                        const openNote = instrument.notes[nextStringIndex];
                                        const openNoteIndex = allNotes.indexOf(openNote);
                                        const stringNoteIndex = (openNoteIndex + frets[nextStringIndex]) % 12;
                                        const expectedNote = allNotes[stringNoteIndex];
                                        
                                        // If this matches the detected note, accept it
                                        if (expectedNote === note) {
                                            chordStringsPlayed.push(nextStringIndex);
                                            chordNotesDetected.push(note);
                                            stringFound = true;
                                        }
                                    }
                                    
                                    if (stringFound) {
                                        // Update progress display in chord notes area
                                        const progressText = `${chordStringsPlayed.length}/${stringsToPlay} cordes jou√©es`;
                                        const notesList = [...new Set(chordNotesDetected)].join(', '); // Show unique notes detected
                                        chordNotesValue.textContent = `${progressText} (${notesList})`;
                                        
                                        // Redraw fretboard if enabled to show updated legend
                                        if (showFretboardCheckbox.checked) {
                                            drawChordFretboard(currentExercise.chord);
                                        }
                                        
                                        // Check if all strings have been played
                                        if (chordStringsPlayed.length >= stringsToPlay) {
                                            // All strings played, advance to next chord
                                            const delayMs = parseFloat(advanceDelayInput.value) * 1000;
                                            setTimeout(() => {
                                                if (isListening) {
                                                    generateExercise();
                                                    hasAutoAdvanced = false;
                                                }
                                            }, delayMs);
                                        }
                                    } else {
                                        // Note not in correct order - reset hasAutoAdvanced to allow next note
                                        hasAutoAdvanced = false;
                                    }
                                }
                            } else {
                                // Wrong note
                                detectedNoteEl.className = 'detected-note incorrect';
                            }
                        } else {
                            detectedNoteEl.className = 'detected-note';
                        }
                    }
                }
            } else {
                // No clear pitch detected, reset and clear display
                if (lastDetectedNote !== null) {
                    lastDetectedNote = null;
                    noteDetectionStartTime = 0;
                    detectedNoteEl.textContent = '‚Äî';
                    detectedNoteEl.className = 'detected-note';
                }
            }
            
            requestAnimationFrame(detectPitch);
        }

        function autoCorrelate(buffer, sampleRate) {
            let size = buffer.length;
            let maxSamples = Math.floor(size / 2);
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;
            
            for (let i = 0; i < size; i++) {
                let val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / size);
            
            if (rms < 0.01) return -1;
            
            let lastCorrelation = 1;
            for (let offset = 1; offset < maxSamples; offset++) {
                let correlation = 0;
                for (let i = 0; i < maxSamples; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / maxSamples);
                
                if (correlation > 0.9 && correlation > lastCorrelation) {
                    let foundGoodCorrelation = false;
                    if (correlation > bestCorrelation) {
                        bestCorrelation = correlation;
                        bestOffset = offset;
                        foundGoodCorrelation = true;
                    }
                }
                lastCorrelation = correlation;
            }
            
            if (bestCorrelation > 0.01) {
                return sampleRate / bestOffset;
            }
            return -1;
        }

        function frequencyToNote(frequency) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const A4 = 440;
            const C0 = A4 * Math.pow(2, -4.75);
            
            if (frequency < 20) return null;
            
            const halfSteps = 12 * Math.log2(frequency / C0);
            const noteIndex = Math.round(halfSteps) % 12;
            
            return noteNames[noteIndex];
        }

        function noteToFrequency(noteName) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const A4 = 440;
            const C4 = 261.63; // Middle C
            
            const noteIndex = noteNames.indexOf(noteName);
            if (noteIndex === -1) return null;
            
            // Return frequency for the note in octave 4 (middle octave)
            const halfStepsFromC4 = noteIndex;
            return C4 * Math.pow(2, halfStepsFromC4 / 12);
        }

        function playNote(noteName, duration = 2000) {
            if (!playSoundCheckbox.checked) return;
            
            const frequency = noteToFrequency(noteName);
            if (!frequency) return;
            
            // Create audio context if not exists
            if (!audioContextSynth) {
                audioContextSynth = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const now = audioContextSynth.currentTime;
            const ctx = audioContextSynth;
            
            // Master gain for the complete sound
            const masterGain = ctx.createGain();
            
            // Body resonance filter (simulates guitar body)
            const bodyFilter = ctx.createBiquadFilter();
            bodyFilter.type = 'bandpass';
            bodyFilter.frequency.setValueAtTime(200, now); // Wood body resonance around 200Hz
            bodyFilter.Q.setValueAtTime(1, now);
            
            // Brightness filter (simulates tone control)
            const brightnessFilter = ctx.createBiquadFilter();
            brightnessFilter.type = 'lowpass';
            brightnessFilter.frequency.setValueAtTime(3500, now); // Cut high frequencies
            brightnessFilter.Q.setValueAtTime(0.7, now);
            
            // Subtle vibrato (LFO)
            const vibrato = ctx.createOscillator();
            const vibratoGain = ctx.createGain();
            vibrato.frequency.setValueAtTime(5, now); // 5Hz vibrato
            vibratoGain.gain.setValueAtTime(0, now);
            vibratoGain.gain.linearRampToValueAtTime(2, now + 0.5); // Vibrato fades in
            vibrato.connect(vibratoGain);
            
            // Guitar sound uses multiple harmonics with different amplitudes
            // Harmonics decay at different rates (inharmonicity)
            const harmonics = [
                { mult: 1.0, gain: 1.0, decay: 1.0 },      // Fundamental
                { mult: 2.0, gain: 0.6, decay: 0.9 },      // 2nd harmonic (octave)
                { mult: 3.0, gain: 0.4, decay: 0.8 },      // 3rd harmonic
                { mult: 4.0, gain: 0.25, decay: 0.7 },     // 4th harmonic
                { mult: 5.0, gain: 0.15, decay: 0.6 },     // 5th harmonic
                { mult: 6.0, gain: 0.1, decay: 0.5 },      // 6th harmonic
                { mult: 7.0, gain: 0.05, decay: 0.4 },     // 7th harmonic
                { mult: 8.0, gain: 0.03, decay: 0.3 }      // 8th harmonic
            ];
            
            harmonics.forEach((harmonic, index) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                // Use sine waves for each harmonic
                osc.type = 'sine';
                osc.frequency.setValueAtTime(frequency * harmonic.mult, now);
                
                // Connect vibrato to this oscillator
                vibratoGain.connect(osc.frequency);
                
                // Slightly detune higher harmonics (inharmonicity)
                if (index > 2) {
                    osc.detune.setValueAtTime(Math.random() * 4 - 2, now);
                }
                
                // Guitar-like ADSR envelope with individual decay rates
                const maxGain = 0.12 * harmonic.gain;
                gain.gain.setValueAtTime(0, now);
                
                // Attack - very fast pluck (slightly randomized per harmonic)
                const attackTime = 0.003 + (index * 0.001);
                gain.gain.linearRampToValueAtTime(maxGain, now + attackTime);
                
                // Decay - quick initial drop
                gain.gain.exponentialRampToValueAtTime(maxGain * 0.7, now + 0.04);
                
                // Sustain - gradual fade (higher harmonics fade faster)
                const sustainFactor = harmonic.decay;
                gain.gain.exponentialRampToValueAtTime(maxGain * 0.4 * sustainFactor, now + 0.3);
                gain.gain.exponentialRampToValueAtTime(maxGain * 0.2 * sustainFactor, now + 0.8);
                gain.gain.exponentialRampToValueAtTime(maxGain * 0.08 * sustainFactor, now + 1.5);
                
                // Release - final fade out
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration/1000);
                
                osc.connect(gain);
                gain.connect(bodyFilter);
                
                osc.start(now);
                osc.stop(now + duration/1000 + 0.1);
            });
            
            vibrato.start(now);
            vibrato.stop(now + duration/1000 + 0.1);
            
            // Add pluck attack noise (simulates pick hitting string)
            const bufferSize = ctx.sampleRate * 0.015; // 15ms of noise
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const noiseData = noiseBuffer.getChannelData(0);
            
            // Filtered noise for realistic pluck
            for (let i = 0; i < bufferSize; i++) {
                const decay = 1 - (i / bufferSize);
                noiseData[i] = (Math.random() * 2 - 1) * 0.15 * decay;
            }
            
            const noiseSource = ctx.createBufferSource();
            noiseSource.buffer = noiseBuffer;
            
            const noiseGain = ctx.createGain();
            noiseGain.gain.setValueAtTime(0.4, now);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.015);
            
            const noiseFilter = ctx.createBiquadFilter();
            noiseFilter.type = 'highpass';
            noiseFilter.frequency.setValueAtTime(frequency * 1.5, now);
            noiseFilter.Q.setValueAtTime(2, now);
            
            noiseSource.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(bodyFilter);
            
            noiseSource.start(now);
            noiseSource.stop(now + 0.015);
            
            // Add subtle string resonance (Karplus-Strong inspired)
            const stringResonance = ctx.createDelay();
            const stringFeedback = ctx.createGain();
            const stringFilter = ctx.createBiquadFilter();
            
            stringResonance.delayTime.setValueAtTime(1 / frequency, now);
            stringFeedback.gain.setValueAtTime(0.3, now);
            stringFilter.type = 'lowpass';
            stringFilter.frequency.setValueAtTime(frequency * 4, now);
            
            bodyFilter.connect(stringResonance);
            stringResonance.connect(stringFilter);
            stringFilter.connect(stringFeedback);
            stringFeedback.connect(stringResonance);
            
            // Final chain
            bodyFilter.connect(brightnessFilter);
            brightnessFilter.connect(masterGain);
            masterGain.connect(ctx.destination);
            
            // Master volume envelope
            masterGain.gain.setValueAtTime(0.8, now);
            masterGain.gain.setValueAtTime(0.8, now + duration/1000 - 0.1);
            masterGain.gain.linearRampToValueAtTime(0, now + duration/1000);
        }

        function frequencyToNote(frequency) {
            const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
            const noteIndex = Math.round(noteNum) + 69;
            const octave = Math.floor(noteIndex / 12) - 1;
            const note = allNotes[noteIndex % 12];
            return note;
        }

        // Event listeners
        nextBtn.addEventListener('click', generateExercise);

        enableAudioCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                audioDetector.style.display = 'block';
                startAudioDetection();
            } else {
                audioDetector.style.display = 'none';
                stopAudioDetection(true); // Full stop - release the stream
            }
        });

        playSoundCheckbox.addEventListener('change', () => {
            // Just update the state, will be used when playing notes
            playNoteSound = playSoundCheckbox.checked;
        });

        // Sync speed mode duration display when input changes
        speedModeDurationInput.addEventListener('change', () => {
            const duration = speedModeDurationInput.value;
            speedModeDurationDisplay.textContent = duration;
            speedModeTimer.textContent = duration;
        });

        // Chord mode controls
        chordTypeMajor.addEventListener('change', () => {
            availableChords = [];
            if (currentMode === 'chords') generateExercise();
        });

        chordTypeMinor.addEventListener('change', () => {
            availableChords = [];
            if (currentMode === 'chords') generateExercise();
        });

        chordsLevel.addEventListener('change', () => {
            availableChords = [];
            if (currentMode === 'chords') generateExercise();
        });

        showFretboardCheckbox.addEventListener('change', () => {
            if (showFretboardCheckbox.checked) {
                instrumentSelection.style.display = 'block';
                fretCountSelection.style.display = 'block';
                // Redraw fretboard with current exercise
                if (currentExercise) {
                    if (currentExercise.type === 'single') {
                        drawFretboard(currentExercise.notes[0].note);
                    } else if (currentExercise.type === 'chord') {
                        drawChordFretboard(currentExercise.chord);
                    }
                }
            } else {
                instrumentSelection.style.display = 'none';
                fretCountSelection.style.display = 'none';
                fretboardDisplay.style.display = 'none';
            }
        });

        instrumentType.addEventListener('change', () => {
            // Initialize enabled strings for new instrument
            initializeEnabledStrings();
            
            // Regenerate exercise to adapt to new instrument string count
            if (currentExercise) {
                generateExercise();
            }
        });

        fretCount.addEventListener('change', () => {
            // Redraw fretboard with new fret count
            if (showFretboardCheckbox.checked && currentExercise) {
                if (currentExercise.type === 'single') {
                    drawFretboard(currentExercise.notes[0].note);
                } else if (currentExercise.type === 'chord') {
                    drawChordFretboard(currentExercise.chord);
                }
            }
        });

        // Toggle settings panel
        let settingsVisible = true; // Start with settings open
        toggleSettingsBtn.addEventListener('click', () => {
            settingsVisible = !settingsVisible;
            if (settingsVisible) {
                settingsPanel.classList.remove('hidden');
                mainGrid.classList.remove('settings-hidden');
                toggleSettingsBtn.textContent = '‚öôÔ∏è';
                
                // Show overlay and disable display panel
                settingsOverlay.style.display = 'block';
                displayPanel.style.opacity = '0.3';
                displayPanel.style.pointerEvents = 'none';
                displayPanel.style.filter = 'blur(3px)';
                
                // Pause audio detection if active (but keep stream alive)
                if (isListening) {
                    stopAudioDetection(false); // Don't release the stream
                    // Remember it was active
                    window._wasListening = true;
                }
            } else {
                settingsPanel.classList.add('hidden');
                mainGrid.classList.add('settings-hidden');
                toggleSettingsBtn.textContent = '‚öôÔ∏è';
                
                // Hide overlay and enable display panel
                settingsOverlay.style.display = 'none';
                displayPanel.style.opacity = '1';
                displayPanel.style.pointerEvents = 'auto';
                displayPanel.style.filter = 'none';
                
                // Start audio detection if checkbox is enabled
                // (either resuming after pause, or starting for the first time)
                if (enableAudioCheckbox.checked && !isListening) {
                    audioDetector.style.display = 'block';
                    startAudioDetection();
                }
                
                // Clear the "was listening" flag
                window._wasListening = false;
            }
        });

        // Close settings when clicking outside the settings panel
        document.addEventListener('click', (e) => {
            // Only if settings are visible
            if (!settingsVisible) return;
            
            // Check if click is outside settings panel and not on toggle button
            const clickedInsideSettings = settingsPanel.contains(e.target);
            const clickedToggleButton = toggleSettingsBtn.contains(e.target);
            
            if (!clickedInsideSettings && !clickedToggleButton) {
                // Close settings (simulate button click)
                toggleSettingsBtn.click();
            }
        });




        // Reset chord pool when chord type selection changes

        // Fretboard visualization functions
        function initializeEnabledStrings() {
            const instrument = instrumentTunings[instrumentType.value];
            enabledStrings = {};
            instrument.strings.forEach((stringName, index) => {
                enabledStrings[index] = true; // All strings enabled by default
            });
        }
        
        function toggleString(stringIndex) {
            enabledStrings[stringIndex] = !enabledStrings[stringIndex];
            // Redraw fretboard
            if (currentExercise && currentExercise.type === 'single') {
                drawFretboard(currentExercise.notes[0].note);
            }
        }
        
        // Make toggleString accessible globally for onclick handlers
        window.toggleString = toggleString;
        
        function findNoteOnFretboard(noteName) {
            const instrument = instrumentTunings[instrumentType.value];
            const positions = [];
            const maxFret = parseInt(fretCount.value);
            
            // For each string (only if enabled)
            instrument.notes.forEach((openNote, stringIndex) => {
                if (!enabledStrings[stringIndex]) return; // Skip disabled strings
                
                // Find note positions on this string
                const openNoteIndex = allNotes.indexOf(openNote);
                const targetNoteIndex = allNotes.indexOf(noteName);
                
                // Calculate fret positions (considering octaves)
                for (let fret = 0; fret <= maxFret; fret++) {
                    const fretNoteIndex = (openNoteIndex + fret) % 12;
                    if (fretNoteIndex === targetNoteIndex) {
                        positions.push({
                            string: stringIndex,
                            fret: fret,
                            stringName: instrument.strings[stringIndex]
                        });
                    }
                }
            });
            
            return positions;
        }
        
        function drawFretboard(noteName) {
            if (!showFretboardCheckbox.checked) {
                fretboardDisplay.style.display = 'none';
                return;
            }
            
            fretboardDisplay.style.display = 'block';
            const positions = findNoteOnFretboard(noteName);
            const instrument = instrumentTunings[instrumentType.value];
            const numStrings = instrument.strings.length;
            const numFrets = parseInt(fretCount.value);
            
            // Adjust cell width based on number of frets for better visibility
            const cellWidth = numFrets <= 12 ? 50 : (numFrets <= 15 ? 45 : 40);
            const minWidth = (numFrets + 1) * cellWidth + 60; // +60 for string names
            
            // Build HTML for fretboard
            let html = `<div style="display: inline-block; min-width: ${minWidth}px; width: max-content;">`;
            
            // Fret numbers header
            html += '<div style="display: flex; align-items: center; margin-bottom: 0.25rem;">';
            html += '<div style="width: 50px;"></div>'; // Spacing for string names
            
            for (let fret = 0; fret <= numFrets; fret++) {
                html += `<div style="width: ${cellWidth}px; text-align: center; font-size: 0.7rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">${fret}</div>`;
            }
            html += '</div>';
            
            // Draw strings (from high to low for visual clarity)
            for (let s = numStrings - 1; s >= 0; s--) {
                const isEnabled = enabledStrings[s];
                const opacity = isEnabled ? '1' : '0.3';
                
                html += '<div style="display: flex; align-items: center; margin-bottom: 0.5rem;">';
                
                // String name - clickable with French notation
                const stringNoteFr = instrument.notesFr[s];
                const stringNum = instrument.strings[s].match(/\d+/)[0]; // Extract octave number
                html += `<div onclick="toggleString(${s})" style="width: 50px; text-align: right; padding-right: 0.5rem; font-size: 0.8rem; color: ${isEnabled ? 'var(--accent-primary)' : 'var(--text-secondary)'}; font-family: 'JetBrains Mono', monospace; cursor: pointer; user-select: none; transition: all 0.2s;" title="Cliquer pour ${isEnabled ? 'd√©sactiver' : 'activer'}">${stringNoteFr}${stringNum}</div>`;
                
                // Frets
                for (let f = 0; f <= numFrets; f++) {
                    // Check if this position has the target note
                    const isHighlight = isEnabled && positions.some(pos => pos.string === s && pos.fret === f);
                    const bgColor = isHighlight ? 'var(--accent-primary)' : (f === 0 ? 'var(--bg-primary)' : 'transparent');
                    const borderColor = f === 0 ? 'var(--border)' : 'var(--text-secondary)';
                    const size = isHighlight ? '18px' : '10px';
                    
                    html += `<div style="width: ${cellWidth}px; height: 30px; display: flex; align-items: center; justify-content: center; border-left: ${f === 0 ? '3' : '1'}px solid ${borderColor}; position: relative; opacity: ${opacity};">`;
                    
                    if (isHighlight) {
                        html += `<div style="width: ${size}; height: ${size}; border-radius: 50%; background: ${bgColor}; box-shadow: 0 0 10px var(--accent-primary); border: 2px solid var(--bg-primary);"></div>`;
                    } else if (f > 0 && isEnabled) {
                        // Fret markers - adapted for different fretboard lengths
                        const standardMarkers = [3, 5, 7, 9, 12, 15, 17, 19, 21, 24];
                        const doubleMarkers = [12, 24];
                        
                        if (standardMarkers.includes(f) && s === Math.floor(numStrings / 2)) {
                            html += `<div style="width: 6px; height: 6px; border-radius: 50%; background: var(--text-secondary); opacity: 0.3;"></div>`;
                        } else if (doubleMarkers.includes(f) && (s === Math.floor(numStrings / 2) || s === Math.floor(numStrings / 2) - 1)) {
                            html += `<div style="width: 6px; height: 6px; border-radius: 50%; background: var(--text-secondary); opacity: 0.3;"></div>`;
                        }
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            
            // Display info about number of positions
            const enabledCount = Object.values(enabledStrings).filter(v => v).length;
            html += `<div style="margin-top: 0.75rem; text-align: center; font-size: 0.85rem; color: var(--accent-primary); font-family: 'JetBrains Mono', monospace;">`;
            html += `${positions.length} position${positions.length > 1 ? 's' : ''} trouv√©e${positions.length > 1 ? 's' : ''} (${enabledCount}/${numStrings} cordes actives, ${numFrets} frettes)`;
            html += '</div>';
            
            html += `<div style="margin-top: 0.5rem; text-align: center; font-size: 0.75rem; color: var(--text-secondary); font-style: italic;">`;
            html += `üí° Cliquez sur le nom d'une corde pour l'activer/d√©sactiver`;
            html += '</div>';
            
            fretboardCanvas.innerHTML = html;
        }

        // Speed mode functions
        function startSpeedMode() {
            speedModeActive = true;
            speedModeCorrectCount = 0;
            speedModeTimeRemaining = parseInt(speedModeDurationInput.value);
            speedModeStartTime = Date.now();
            
            // Update UI
            speedModeScore.textContent = '0';
            speedModeTimer.textContent = speedModeTimeRemaining;
            speedModeStartBtn.textContent = '‚ñ† Arr√™ter';
            speedModeStartBtn.onclick = stopSpeedMode;
            
            // Make sure audio is enabled
            if (!enableAudioCheckbox.checked) {
                enableAudioCheckbox.checked = true;
                audioDetector.style.display = 'block';
                startAudioDetection();
            }
            
            // Start timer
            speedModeTimerInterval = setInterval(() => {
                speedModeTimeRemaining--;
                speedModeTimer.textContent = speedModeTimeRemaining;
                
                // Change color when time is running out
                if (speedModeTimeRemaining <= 10) {
                    speedModeTimer.style.color = 'var(--accent-danger)';
                } else if (speedModeTimeRemaining <= 30) {
                    speedModeTimer.style.color = 'var(--accent-warning)';
                }
                
                if (speedModeTimeRemaining <= 0) {
                    endSpeedMode();
                }
            }, 1000);
            
            // Generate first note
            generateExercise();
        }
        
        function stopSpeedMode() {
            speedModeActive = false;
            
            if (speedModeTimerInterval) {
                clearInterval(speedModeTimerInterval);
                speedModeTimerInterval = null;
            }
            
            // Reset UI
            speedModeTimeRemaining = parseInt(speedModeDurationInput.value);
            speedModeTimer.textContent = speedModeTimeRemaining;
            speedModeScore.textContent = '0';
            speedModeCorrectCount = 0;
            speedModeStartBtn.textContent = '‚ñ∂ D√©marrer le d√©fi';
            speedModeStartBtn.onclick = startSpeedMode;
            speedModeTimer.style.color = 'var(--accent-primary)';
        }
        
        function endSpeedMode() {
            // Save score BEFORE stopSpeedMode resets it
            const finalScore = speedModeCorrectCount;
            const timeElapsed = (Date.now() - speedModeStartTime) / 1000;
            const notesPerMinute = Math.round((finalScore / timeElapsed) * 60);
            
            stopSpeedMode();
            
            // Show final score with saved values
            alert(`üéâ D√©fi termin√© !\n\nScore : ${finalScore} notes correctes\nVitesse : ${notesPerMinute} notes/min`);
        }
        
        function incrementSpeedModeScore() {
            if (speedModeActive) {
                speedModeCorrectCount++;
                speedModeScore.textContent = speedModeCorrectCount;
            }
        }

        // Initialize
        initializeEnabledStrings();
        generateExercise();
        
        // Display version number
        document.getElementById('appVersion').textContent = APP_VERSION;
        
        // Speed mode start button
        speedModeStartBtn.onclick = startSpeedMode;
        
        // Don't auto-start microphone since settings are open at startup
        // Microphone will be started when user closes settings and begins training
        
        // Register Service Worker for PWA (only on proper domains)
        if ('serviceWorker' in navigator && isValidDomain) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker enregistr√©:', registration);
                    })
                    .catch(error => {
                        console.log('Erreur Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>